#!/bin/bash

set -e -u

curl -L -o cf.tgz 'https://cli.run.pivotal.io/stable?release=linux64-binary&version=6.21.1&source=github-rel'
tar -xzf cf.tgz
mkdir -p /tmp/bin
mv cf /tmp/bin/cf
export PATH=$PATH:/tmp/bin
cf -v

environment_path="${PWD}/deployments-repo/environments/${ENVIRONMENT_NAME}"
export CONFIG=$environment_path/netman-cf-acceptance.json

export NETWORK_STATS_FILE=$PWD/network-stats/stats.json

cd netman-release
export GOPATH=$PWD

go build -o /tmp/bin/network-policy-plugin ./src/cli-plugin
cf install-plugin -f /tmp/bin/network-policy-plugin

cd src/netman-cf-acceptance
export APPS_DIR=../example-apps
ginkgo -r -v
