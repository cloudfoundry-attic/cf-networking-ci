{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Launches N BOSH-Lite VMs on top of an existing VPC",
  "Parameters": {
    "AMI": {
      "ConstraintDescription": "should be an AMI from the latest cloudfoundry/bosh-lite Vagrant box",
      "Description": "AMI to boot",
      "Type": "String"
    },
    "BoshAdminPassword": {
      "Description": "Password to set for the admin user on the BOSH director",
      "MinLength": "8",
      "NoEcho": "true",
      "Type": "String"
    },
    "InstanceCount": {
      "Default": "1",
      "Description": "Number of EC2 instances to boot for the classroom",
      "Type": "Number"
    },
    "InstanceType": {
      "ConstraintDescription": "must be a valid EC2 instance type.",
      "Default": "m3.xlarge",
      "Description": "EC2 Instance Type",
      "Type": "String"
    },
    "KeyName": {
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair",
      "Description": "The EC2 Key Pair to allow SSH access to the instances",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "SecurityGroup": {
      "Description": "Security group to apply to the VMs",
      "Type": "AWS::EC2::SecurityGroup::Id"
    },
    "Subnet": {
      "Description": "Subnet id to hold the VMs",
      "Type": "AWS::EC2::Subnet::Id"
    }
  },
  "Resources": {
    "AutoScalingGroup": {
      "Properties": {
        "LaunchConfigurationName": {"Ref": "LaunchConfig"},
        "MaxSize": {"Ref": "InstanceCount"},
        "MinSize": {"Ref": "InstanceCount"},
        "Tags": [
          {"Key": "Name", "PropagateAtLaunch": "true", "Value": "bosh-lite"}
        ],
        "VPCZoneIdentifier": [{"Ref": "Subnet"}]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup"
    },
    "LaunchConfig": {
      "Properties": {
        "AssociatePublicIpAddress": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {"VolumeSize": "100", "VolumeType": "gp2"}
          }
        ],
        "EbsOptimized": "true",
        "ImageId": {"Ref": "AMI"},
        "InstanceType": {"Ref": "InstanceType"},
        "KeyName": {"Ref": "KeyName"},
        "SecurityGroups": [{"Ref": "SecurityGroup"}],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "set -e -x -u",
                "apt-get update -y",
                "cd /home/ubuntu",
                "sudo -u ubuntu bosh target lite",
                {
                  "Fn::Join": [
                    " ",
                    [
                      "sudo -u ubuntu bosh create user admin",
                      {"Ref": "BoshAdminPassword"}
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    " ",
                    [
                      "sudo -u ubuntu bosh login admin",
                      {"Ref": "BoshAdminPassword"}
                    ]
                  ]
                }
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    }
  }
}
